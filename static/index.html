<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台灣醫療門診追蹤系統</title>
  <meta name="description" content="即時追蹤台灣各大醫院門診進度，在輪到您前收到通知">
  <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>

  <!-- ══════════════════════════════════════
     AUTH SCREEN
══════════════════════════════════════ -->
  <div id="auth-page">
    <div class="auth-card">
      <div class="auth-logo">
        <div class="icon-wrap">🏥</div>
        <h1>門診追蹤系統</h1>
        <p>台灣醫療掛號即時通知平台</p>
      </div>

      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchTab('login')">登入</button>
        <button class="auth-tab" onclick="switchTab('register')">註冊</button>
      </div>

      <!-- Login Form -->
      <form id="login-form" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>電子郵件</label>
          <input type="email" id="login-email" placeholder="name@example.com" required>
        </div>
        <div class="form-group">
          <label>密碼</label>
          <input type="password" id="login-password" placeholder="••••••••" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%; justify-content:center; margin-top:4px;"
          id="login-btn">
          登入
        </button>
      </form>

      <!-- Register Form -->
      <form id="register-form" style="display:none" onsubmit="handleRegister(event)">
        <div class="form-group">
          <label>顯示名稱</label>
          <input type="text" id="reg-name" placeholder="您的名字">
        </div>
        <div class="form-group">
          <label>電子郵件</label>
          <input type="email" id="reg-email" placeholder="name@example.com" required>
        </div>
        <div class="form-group">
          <label>密碼（至少8位）</label>
          <input type="password" id="reg-password" placeholder="••••••••" required minlength="8">
        </div>

        <button type="submit" class="btn btn-primary" style="width:100%; justify-content:center; margin-top:4px;"
          id="register-btn">
          建立帳號
        </button>
      </form>
    </div>
  </div>

  <!-- ══════════════════════════════════════
     MAIN APP LAYOUT
══════════════════════════════════════ -->
  <div class="layout" id="app" style="display:none">

    <!-- Topbar -->
    <header class="topbar">
      <div class="logo">
        <div class="icon">🏥</div>
        門診追蹤系統
      </div>
      <div class="spacer"></div>
      <div class="user-info">
        <div class="avatar" id="user-avatar">U</div>
        <span id="user-name-display"></span>
        <button id="btn-logout" onclick="handleLogout()">登出</button>
      </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar">
      <button class="nav-item active" data-page="dashboard" onclick="navigate(this, 'dashboard')">
        <span class="nav-icon">📊</span> 總覽
      </button>
      <button class="nav-item" data-page="analysis" onclick="navigate(this, 'analysis')">
        <span class="nav-icon">📈</span> 圖表分析
      </button>
      <button class="nav-item" data-page="hospitals" onclick="navigate(this, 'hospitals')">
        <span class="nav-icon">🏥</span> 醫院查詢
      </button>
      <button class="nav-item" data-page="tracking" onclick="navigate(this, 'tracking')">
        <span class="nav-icon">🔔</span> 我的追蹤
      </button>
      <button class="nav-item" data-page="add-tracking" onclick="navigate(this, 'add-tracking')" id="nav-add-tracking"
        style="display:none">
        <span class="nav-icon">➕</span> 新增追蹤
      </button>
      <button class="nav-item" data-page="notifications" onclick="navigate(this, 'notifications')">
        <span class="nav-icon">📬</span> 通知紀錄
      </button>
      <button class="nav-item admin-only" id="admin-nav-btn" data-page="admin" onclick="navigate(this, 'admin')"
        style="display:none">
        <span class="nav-icon">👑</span> 會員管理
      </button>
      <div class="sidebar-footer">
        <button class="nav-item" data-page="profile" onclick="navigate(this, 'profile')">
          <span class="nav-icon">⚙️</span> 個人設定
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main">

      <!-- ── Dashboard ── -->
      <section id="page-dashboard" class="page active">
        <div class="section-header">
          <div>
            <h2>📊 今日門診總覽</h2>
            <div class="subtitle" id="last-update-label">讀取中…</div>
          </div>
          <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <!-- Hospital Filter Combobox -->
            <div class="combobox" id="dash-hosp-combo" style="width:280px">
              <input type="text" placeholder="🔍 過濾醫院 (預設全部)..." autocomplete="off" oninput="filterDashHosp(this.value)"
                onfocus="showDashHospList()">
              <span class="combo-arrow" onclick="toggleDashHosp()">▼</span>
              <div class="combo-dropdown" id="dash-hosp-list"></div>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="refreshAll()">
              🔄 立即更新
            </button>
          </div>
        </div>

        <div class="stat-grid">
          <div class="stat-card" style="--gradient: linear-gradient(90deg, #3B82F6, #06B6D4)">
            <div class="stat-icon">🏥</div>
            <div class="stat-value" id="stat-hospitals">—</div>
            <div class="stat-label">追蹤中醫院</div>
          </div>
          <div class="stat-card" style="--gradient: linear-gradient(90deg, #10B981, #34D399)">
            <div class="stat-icon">👨‍⚕️</div>
            <div class="stat-value" id="stat-doctors">—</div>
            <div class="stat-label">今日門診醫師</div>
          </div>
          <div class="stat-card" style="--gradient: linear-gradient(90deg, #F59E0B, #FBBF24)">
            <div class="stat-icon">🔔</div>
            <div class="stat-value" id="stat-tracking">—</div>
            <div class="stat-label">追蹤中門診</div>
          </div>
          <div class="stat-card" style="--gradient: linear-gradient(90deg, #EF4444, #F87171)">
            <div class="stat-icon">📣</div>
            <div class="stat-value" id="stat-alerts">—</div>
            <div class="stat-label">今日通知</div>
          </div>
        </div>

        <!-- Crowd Analysis Chart -->
        <div class="section-header" style="margin-top:24px;">
          <div>
            <h2>📈 各時段擁擠度分析</h2>
            <div class="subtitle">依據近期全院門診註冊量平均計算，助您避開尖峰時段</div>
          </div>
        </div>
        <div class="card" style="margin-bottom:24px; position:relative; height:280px;">
          <canvas id="crowd-chart"></canvas>
        </div>

        <!-- My tracking quick view -->
        <div class="section-header">
          <h2>🔔 追蹤門診進度</h2>
          <button class="btn btn-primary btn-sm"
            onclick="navigate(document.querySelector('[data-page=tracking]'), 'tracking')">
            管理追蹤
          </button>
        </div>
        <div id="dashboard-tracking-grid" class="card-grid">
          <div class="spinner"></div>
        </div>
      </section>

      <!-- ── Chart Analysis ── -->
      <section id="page-analysis" class="page">
        <div class="section-header">
          <div>
            <h2>📈 圖表統計分析</h2>
            <div class="subtitle">視覺化分析醫院門診負荷與醫師看診差異</div>
          </div>
        </div>

        <div class="hs-tabs"
          style="margin-bottom:20px; display:flex; gap:10px; border-bottom:1px solid var(--border); padding-bottom:10px;">
          <button class="btn btn-primary" id="btn-tab-sheet1" onclick="switchAnalysisSheet('sheet1')">📊
            各科室負荷比較</button>
          <button class="btn btn-secondary" id="btn-tab-sheet2" onclick="switchAnalysisSheet('sheet2')">👨‍⚕️
            醫師看診進度</button>
          <button class="btn btn-secondary" id="btn-tab-sheet4" onclick="switchAnalysisSheet('sheet4')">⚡
            醫師看診速度</button>
          <button class="btn btn-secondary" id="btn-tab-sheet3" onclick="switchAnalysisSheet('sheet3')">🏆
            看診人數排行</button>
        </div>

        <!-- Sheet 1: Dept Comparison -->
        <div id="analysis-sheet1" class="analysis-tab-content">
          <div class="card" style="margin-bottom:20px">
            <div style="display:flex; gap:14px; align-items:flex-end; flex-wrap:wrap">
              <div class="form-group" style="margin:0; min-width:200px;">
                <label>醫院</label>
                <select id="analysis-sheet1-hosp-select" onchange="loadDeptComparison()">
                  <option value="">所有醫院</option>
                </select>
              </div>
              <div class="form-group" style="margin:0; min-width:200px;">
                <label>科室類別</label>
                <select id="analysis-sheet1-cat-select" onchange="loadDeptComparison()">
                  <option value="">所有類別</option>
                </select>
              </div>
            </div>
          </div>
          <div class="card" style="position:relative; height:450px;">
            <canvas id="dept-comparison-chart"></canvas>
          </div>
        </div>

        <!-- Sheet 2: Doctor Comparison -->
        <div id="analysis-sheet2" class="analysis-tab-content" style="display:none">
          <div class="card" style="margin-bottom:20px">
            <div style="display:flex; gap:14px; align-items:flex-end; flex-wrap:wrap">
              <div class="form-group" style="margin:0; min-width:180px;">
                <label>選擇醫院</label>
                <select id="analysis-sheet2-hosp-select" onchange="loadAnalysisDepts()"></select>
              </div>
              <div class="form-group" style="margin:0; min-width:180px;">
                <label>科室類別</label>
                <select id="analysis-sheet2-cat-select" onchange="loadAnalysisDepts()">
                  <option value="">所有類別</option>
                </select>
              </div>
              <div class="form-group" style="margin:0; min-width:180px;">
                <label>選擇科室</label>
                <select id="analysis-sheet2-dept-select" onchange="refreshDoctorComparison()"></select>
              </div>
            </div>
          </div>
          <div class="card" style="position:relative; height:400px;">
            <canvas id="doctor-comparison-chart"></canvas>
          </div>
        </div>

        <!-- Sheet 3: Ranking -->
        <div id="analysis-sheet3" class="analysis-tab-content" style="display:none">
          <div class="card" style="margin-bottom:20px">
            <div style="display:flex; gap:14px; align-items:flex-end; flex-wrap:wrap">
              <div class="form-group" style="margin:0; min-width:180px;">
                <label>醫院</label>
                <select id="rank-hosp-filter" onchange="filterRankingTable()"></select>
              </div>
              <div class="form-group" style="margin:0; min-width:180px;">
                <label>科室</label>
                <input type="text" id="rank-dept-filter" placeholder="關鍵字搜尋…" oninput="filterRankingTable()"
                  style="height:38px; border:1px solid var(--border); border-radius:6px; padding:0 12px;">
              </div>
            </div>
          </div>
          <div class="table-wrap">
            <table id="ranking-table">
              <thead>
                <tr>
                  <th>醫院</th>
                  <th>科室名稱</th>
                  <th>最高看診數</th>
                  <th>平均看診數</th>
                </tr>
              </thead>
              <tbody id="ranking-table-body">
                <tr>
                  <td colspan="4" style="text-align:center; padding:32px;">讀取中…</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Sheet 4: Doctor Speed Analysis -->
        <div id="analysis-sheet4" class="analysis-tab-content" style="display:none">
          <div class="card" style="margin-bottom:20px">
            <div style="display:flex; gap:14px; align-items:flex-end; flex-wrap:wrap">
              <div class="form-group" style="margin:0; min-width:200px;">
                <label>醫院</label>
                <select id="analysis-sheet4-hosp-select"
                  onchange="(async()=>{ await loadAnalysisDepts('analysis-sheet4-hosp-select','analysis-sheet4-cat-select','analysis-sheet4-dept-select'); loadDoctorSpeedAnalysis(); })()">
                  <option value="">所有醫院</option>
                </select>
              </div>
              <div class="form-group" style="margin:0; min-width:200px;">
                <label>科室類別</label>
                <select id="analysis-sheet4-cat-select"
                  onchange="(async()=>{ await loadAnalysisDepts('analysis-sheet4-hosp-select','analysis-sheet4-cat-select','analysis-sheet4-dept-select'); loadDoctorSpeedAnalysis(); })()">
                  <option value="">所有類別</option>
                </select>
              </div>
              <div class="form-group" style="margin:0; min-width:200px;">
                <label>科室</label>
                <select id="analysis-sheet4-dept-select" onchange="loadDoctorSpeedAnalysis()">
                  <option value="">所有科室</option>
                </select>
              </div>
            </div>
          </div>
          <div class="card" style="position:relative; height:450px;">
            <canvas id="doctor-speed-chart"></canvas>
          </div>
        </div>
      </section>

      <!-- ── Hospital Query ── -->
      <section id="page-hospitals" class="page">
        <div class="section-header">
          <div>
            <h2>🏥 醫院 / 科室 / 醫師查詢</h2>
            <div class="subtitle">選擇醫院與科室類別，瀏覽醫師門診狀況</div>
          </div>
        </div>

        <!-- Hospital select + Search bars -->
        <div class="card" style="margin-bottom:20px">
          <div style="display:flex; gap:14px; align-items:flex-end; flex-wrap:wrap">
            <div class="form-group" style="margin:0; min-width:240px; flex:2">
              <label>選擇醫院</label>
              <div class="combobox" id="cb-hospital">
                <input type="text" id="hospital-input" placeholder="輸入或選擇醫院…" autocomplete="off"
                  oninput="filterCombo('cb-hospital')" onfocus="openCombo('cb-hospital')" disabled>
                <span class="combo-arrow" onclick="toggleCombo('cb-hospital')">▼</span>
                <div class="combo-dropdown" id="cb-hospital-list"></div>
              </div>
            </div>

            <div id="hs-search-controls" style="display:none; flex:3; gap:10px; align-items:flex-end; min-width:400px">
              <div class="search-bar" style="flex:1; margin-bottom:0">
                <span class="search-icon">🔍</span>
                <input type="text" id="dept-search" placeholder="搜尋科室…" oninput="filterHospitalSearch()">
              </div>
              <div class="search-bar" style="flex:1; margin-bottom:0">
                <span class="search-icon">👨‍⚕️</span>
                <input type="text" id="doctor-search" placeholder="搜尋醫師…" oninput="filterHospitalSearch()">
              </div>
              <button class="btn btn-secondary" style="height:42px" onclick="resetHospitalSearch()">恢復預設</button>
            </div>
          </div>
        </div>

        <!-- Breadcrumb -->
        <div id="hs-breadcrumb" class="breadcrumb" style="display:none; margin-bottom:15px"></div>

        <!-- Category chips -->
        <div id="hs-category-wrap" style="display:none; margin-bottom:18px">
          <div class="category-chips" id="hs-category-chips"></div>
        </div>

        <!-- Department grid -->
        <div id="hs-dept-wrap" style="display:none; margin-bottom:18px">
          <div class="dept-section-label" id="hs-dept-label"></div>
          <div class="dept-btn-grid" id="hs-dept-grid"></div>
        </div>


        <!-- Doctor cards -->
        <div id="doctors-grid" class="card-grid">
          <div class="empty-state">
            <div class="empty-icon">🔍</div>
            <p>請先選擇醫院與科室</p>
          </div>
        </div>
      </section>

      <!-- ── Tracking ── -->
      <section id="page-tracking" class="page">
        <div class="section-header">
          <div>
            <h2>🔔 我的追蹤清單</h2>
            <div class="subtitle">設定門診提醒，在輪到您前收到通知</div>
          </div>
          <button class="btn btn-primary btn-sm"
            onclick="navigate(document.querySelector('[data-page=add-tracking]'), 'add-tracking')">
            ＋ 新增追蹤
          </button>
        </div>
        <div class="hs-tabs" style="margin-bottom:16px; display:flex; gap:8px;">
          <button class="btn btn-primary" id="btn-tab-tracking-current" onclick="switchTrackingTab('current')">📅
            現在/未來的追蹤</button>
          <button class="btn btn-secondary" id="btn-tab-tracking-past" onclick="switchTrackingTab('past')">⏳
            過去的追蹤</button>
        </div>
        <div id="tracking-list" class="card-grid">
          <div class="spinner"></div>
        </div>
      </section>

      <!-- ── Notification Logs ── -->
      <section id="page-notifications" class="page">
        <div class="section-header">
          <h2>📬 通知紀錄</h2>
        </div>

        <div class="hs-tabs"
          style="margin-bottom:20px; display:flex; gap:10px; border-bottom:1px solid var(--border); padding-bottom:10px;">
          <button class="btn btn-primary" id="btn-tab-notif-current" onclick="switchNotifTab('current')">📅
            目前及未來的通知</button>
          <button class="btn btn-secondary" id="btn-tab-notif-past" onclick="switchNotifTab('past')">⏳ 過去的通知</button>
        </div>

        <div class="table-wrap" style="max-height: 500px; overflow-y: auto;">
          <table>
            <thead style="position: sticky; top: 0; background: var(--bg-hover); z-index: 1;">
              <tr>
                <th>時間</th>
                <th>醫院 / 科室 / 日期</th>
                <th>醫師 / 診間</th>
                <th>目前號碼</th>
                <th>門檻</th>
                <th>管道</th>
                <th>狀態</th>
              </tr>
            </thead>
            <tbody id="notif-table-body">
              <tr>
                <td colspan="7" style="text-align:center; padding:32px; color:var(--text-muted)">
                  <div class="spinner"></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- ── Admin ── -->
      <section id="page-admin" class="page">
        <div class="section-header" style="margin-bottom:20px">
          <h2>👑 管理員後台</h2>
        </div>

        <!-- Admin Tabs -->
        <div class="hs-tabs"
          style="margin-bottom:20px; display:flex; gap:10px; border-bottom:1px solid var(--border); padding-bottom:10px;">
          <button class="btn btn-primary" id="admin-tab-btn-users" onclick="switchAdminTab('users')">👥 會員管理</button>
          <button class="btn btn-secondary" id="admin-tab-btn-tracking" onclick="switchAdminTab('tracking')">📋
            追蹤紀錄管理</button>
          <button class="btn btn-secondary" id="admin-tab-btn-system" onclick="switchAdminTab('system')">⚙️
            系統排程與日誌</button>
        </div>

        <!-- Tab: Users -->
        <div id="admin-tab-users" class="admin-tab-content">
          <div class="section-header" style="margin-bottom:10px">
            <h3>會員列表</h3>
            <button class="btn btn-secondary btn-sm" onclick="loadAdminUsers()">🔄 重新整理會員</button>
          </div>
          <div class="card" style="overflow-x:auto; margin-bottom:24px">
            <table style="width:100%; border-collapse:collapse; font-size:14px">
              <thead>
                <tr style="text-align:left; border-bottom:2px solid var(--border)">
                  <th style="padding:10px 12px">Email</th>
                  <th style="padding:10px 12px">顯示名稱</th>
                  <th style="padding:10px 12px">Email 已驗證</th>
                  <th style="padding:10px 12px">管理員</th>
                  <th style="padding:10px 12px">註冊時間</th>
                  <th style="padding:10px 12px">操作</th>
                </tr>
              </thead>
              <tbody id="admin-users-tbody">
                <tr>
                  <td colspan="6" style="padding:20px; text-align:center; color:var(--text-muted)">載入中…</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Tab: Tracking -->
        <div id="admin-tab-tracking" class="admin-tab-content" style="display:none;">
          <div class="section-header" style="margin-bottom:10px">
            <h3>所有追蹤紀錄</h3>
            <button class="btn btn-secondary btn-sm" onclick="loadAdminTracking()">🔄 重新整理追蹤</button>
          </div>
          <div class="card" style="overflow-x:auto; margin-bottom:24px">
            <table style="width:100%; border-collapse:collapse; font-size:14px">
              <thead>
                <tr style="text-align:left; border-bottom:2px solid var(--border)">
                  <th style="padding:10px 12px">用戶Email / 名稱</th>
                  <th style="padding:10px 12px">就診日期</th>
                  <th style="padding:10px 12px">醫院 / 科室</th>
                  <th style="padding:10px 12px">醫師 / 診號</th>
                  <th style="padding:10px 12px">通知設定</th>
                  <th style="padding:10px 12px">狀態</th>
                  <th style="padding:10px 12px">操作</th>
                </tr>
              </thead>
              <tbody id="admin-tracking-tbody">
                <tr>
                  <td colspan="7" style="padding:20px; text-align:center; color:var(--text-muted)">載入中…</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Tab: System -->
        <div id="admin-tab-system" class="admin-tab-content" style="display:none;">
          <div class="section-header" style="margin-bottom:10px">
            <h3>系統排程與日誌</h3>
            <div>
              <button class="btn btn-secondary btn-sm" onclick="loadSchedulerStatus()">🔄 刷新狀態</button>
              <button class="btn btn-primary btn-sm" onclick="loadServerLogs()">📄 讀取最新日誌</button>
            </div>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:24px">
            <!-- Scheduler Status -->
            <div class="card">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
                <h3 style="font-size:16px">背景排程任務 (Scheduler)</h3>
                <span id="scheduler-status-badge"
                  style="padding:4px 8px; border-radius:4px; font-size:12px; font-weight:bold; background:var(--border)">未知</span>
              </div>
              <div id="scheduler-jobs-list"
                style="font-size:14px; color:var(--text); margin-bottom:16px; line-height:1.6">
                載入中...
              </div>
              <div style="display:flex; gap:10px">
                <button class="btn btn-secondary" id="btn-pause-scheduler" onclick="toggleScheduler(false)" disabled>⏸
                  暫停所有排程</button>
                <button class="btn btn-primary" id="btn-resume-scheduler" onclick="toggleScheduler(true)" disabled>▶
                  恢復所有排程</button>
              </div>
            </div>

            <!-- Server Logs Viewer -->
            <div class="card" style="display:flex; flex-direction:column; max-height:400px">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
                <h3 style="font-size:16px">伺服器日誌 (server.log)</h3>
                <button class="btn btn-secondary btn-sm" onclick="clearServerLogs()" style="color:var(--danger)">🗑
                  清空日誌</button>
              </div>
              <div style="font-size:12px; color:var(--text-muted); margin-bottom:8px">
                <span id="log-file-size">大小: --</span> | <span id="log-file-time">最後更新: --</span>
              </div>
              <pre id="server-log-content"
                style="flex:1; overflow-y:auto; background:#111; color:#0f0; padding:12px; border-radius:6px; font-size:12px; font-family:monospace; margin:0; white-space:pre-wrap; word-wrap:break-word;">
準備讀取日誌...
              </pre>
            </div>
          </div>
        </div>
      </section>

      <!-- ── Profile ── -->
      <section id="page-profile" class="page">
        <div class="section-header">
          <h2>⚙️ 個人設定</h2>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; max-width:700px">
          <div class="card">
            <h3 style="margin-bottom:16px; font-size:16px">👤 基本資料</h3>
            <form onsubmit="saveProfile(event)">
              <div class="form-group">
                <label>登入電子郵件</label>
                <input type="text" id="profile-email" readonly
                  style="background:var(--bg-active); border-color:transparent; color:var(--text-muted)">
              </div>
              <div class="form-group">
                <label>顯示名稱</label>
                <input type="text" id="profile-name" placeholder="您的名字">
              </div>
              <button type="submit" class="btn btn-primary">儲存</button>
            </form>
          </div>
          <div class="card">
            <h3 style="margin-bottom:8px; font-size:16px">📲 LINE 通知設定</h3>
            <p style="font-size:13px; color:var(--text-muted); margin-bottom:14px">
              掃描 QR Code 連結 LINE Bot 接收門診通知
            </p>
            <div style="background: linear-gradient(135deg, #00B900, #0AFF0A); border-radius: 12px; padding: 20px; text-align: center;">
              <div style="background: #fff; padding: 12px; border-radius: 8px; display: inline-block; margin-bottom: 12px;">
                <img src="/static/images/line-qr-code.png" alt="LINE QR Code" style="width: 180px; height: 180px;">
              </div>
              <p style="font-size: 12px; color: #fff; margin: 8px 0; font-weight: 500;">
                掃描 QR Code 連結帳號
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- ── Add Tracking Stepper ── -->
      <section id="page-add-tracking" class="page">
        <div class="section-header">
          <div>
            <h2>➕ 新增門診追蹤</h2>
            <div class="subtitle" id="stepper-subtitle">選擇醫院開始</div>
          </div>
          <div style="display:flex; gap:8px">
            <button class="btn btn-secondary btn-sm" id="stepper-back-btn" onclick="stepperPrevious()" style="display:none">← 上一步</button>
            <button class="btn btn-secondary btn-sm" onclick="cancelAddTracking()">✕ 取消</button>
          </div>
        </div>

        <!-- Step progress bar -->
        <div class="stepper-bar" id="stepper-bar">
          <div class="stepper-step active" data-step="1">1<span>選醫院</span></div>
          <div class="stepper-step" data-step="2">2<span>選科室</span></div>
          <div class="stepper-step" data-step="3">3<span>選醫師</span></div>
          <div class="stepper-step" data-step="4">4<span>日期設定</span></div>
          <div class="stepper-step" data-step="5">5<span>確認送出</span></div>
        </div>

        <!-- Breadcrumb -->
        <div class="hs-breadcrumb" id="stepper-breadcrumb" style="margin-bottom:18px"></div>

        <!-- Step content areas -->
        <div id="step-1-content">
          <div class="dept-btn-grid" id="step1-hospital-grid">
            <div class="spinner"></div>
          </div>
        </div>
        <div id="step-2-content" style="display:none">
          <div class="category-chips" id="step2-category-chips" style="margin-bottom:16px"></div>
          <div class="dept-btn-grid" id="step2-dept-grid"></div>
        </div>
        <div id="step-3-content" style="display:none">
          <div class="card-grid" id="step3-doctor-grid"></div>
        </div>
        <div id="step-4-content" style="display:none">
          <div class="card" style="max-width:480px">
            <div class="form-row">
              <div class="form-group">
                <label>就診日期</label>
                <select id="modal-date" disabled>
                  <option value="">— 請先完成第3步 —</option>
                </select>
              </div>
              <div class="form-group">
                <label>診次</label>
                <select id="modal-session" disabled>
                  <option value="">—</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>我的掛號號碼 <span style="color:var(--text-muted); font-weight:normal">(選填)</span></label>
              <input type="number" id="modal-appointment-number" placeholder="例如：45" min="1" max="999">
            </div>
            <div class="form-group">
              <label>通知門檻</label>
              <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox" id="notify-20" checked> 前 20 位等候人士</label>
                <label class="checkbox-item"><input type="checkbox" id="notify-10" checked> 前 10 位等候人士</label>
                <label class="checkbox-item"><input type="checkbox" id="notify-5" checked> 前 5 位等候人士</label>
              </div>
            </div>
            <div class="form-group">
              <label>通知管道</label>
              <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox" id="notify-email" checked> 📧 Email</label>
                <label class="checkbox-item"><input type="checkbox" id="notify-line"> 📲 LINE Notify</label>
              </div>
            </div>
            <input type="hidden" id="modal-dept">
            <input type="hidden" id="modal-doctor">
            <button class="btn btn-primary" style="margin-top:10px" onclick="stepperNextFromStep4()">下一步 →</button>
          </div>
        </div>
        <div id="step-5-content" style="display:none">
          <div class="card" style="max-width:480px">
            <h3 style="margin-bottom:18px; font-size:16px">📋 確認追蹤資訊</h3>
            <div id="confirm-summary" style="font-size:14px; line-height:2; color:var(--text)"></div>
            <div style="display:flex; gap:10px; margin-top:20px">
              <button class="btn btn-secondary" onclick="stepperGoTo(4)">← 上一步</button>
              <button class="btn btn-primary" id="submit-tracking-btn" onclick="submitTracking(event)">✅ 確認新增追蹤</button>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Old tracking modal removed; replaced by #page-add-tracking stepper -->

  <!-- Quick Track Modal (from hospital search) -->
  <div class="modal-overlay" id="quick-track-modal" onclick="closeModalIfOverlay(event)">
    <div class="modal" style="max-width:500px">
      <div class="modal-header">
        <h3 id="quick-track-title">快速追蹤</h3>
        <button class="modal-close"
          onclick="closeQuickTrackModal()">✕</button>
      </div>
      <div class="modal-body">
        <div id="quick-track-doctor-info" style="padding:12px; background:var(--bg-hover); border-radius:8px; margin-bottom:16px">
          <div style="font-weight:600">👨‍⚕️ <span id="qt-doctor-name">—</span></div>
          <div style="font-size:12px; color:var(--text-muted)"><span id="qt-hospital-dept">—</span></div>
        </div>
        <div class="form-group">
          <label>就診日期</label>
          <select id="qt-date" disabled>
            <option value="">— 載入中… —</option>
          </select>
        </div>
        <div class="form-group">
          <label>診次</label>
          <select id="qt-session" disabled>
            <option value="">— 請先選擇日期 —</option>
          </select>
        </div>
        <div class="form-group">
          <label>我的掛號號碼 <span style="color:var(--text-muted); font-weight:normal">(選填)</span></label>
          <input type="number" id="qt-appointment-number" placeholder="例如：45" min="1" max="999">
        </div>
        <div class="form-group">
          <label>通知門檻</label>
          <div class="checkbox-group">
            <label class="checkbox-item"><input type="checkbox" id="qt-notify-20" checked> 前 20 位等候人士</label>
            <label class="checkbox-item"><input type="checkbox" id="qt-notify-10" checked> 前 10 位等候人士</label>
            <label class="checkbox-item"><input type="checkbox" id="qt-notify-5" checked> 前 5 位等候人士</label>
          </div>
        </div>
        <div class="form-group">
          <label>通知管道</label>
          <div class="checkbox-group">
            <label class="checkbox-item"><input type="checkbox" id="qt-notify-email" checked> 📧 Email</label>
            <label class="checkbox-item"><input type="checkbox" id="qt-notify-line"> 📲 LINE Notify</label>
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:20px">
          <button class="btn btn-secondary" onclick="closeQuickTrackModal()" style="flex:1">取消</button>
          <button class="btn btn-primary" onclick="submitQuickTrack()" style="flex:1">確認追蹤</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Clinic Waiting List Modal -->
  <div class="modal-overlay" id="clinic-waiting-modal" onclick="closeModalIfOverlay(event)">
    <div class="modal" style="max-width:600px; max-height:80vh; overflow-y:auto">
      <div class="modal-header">
        <div>
          <h3 id="clinic-waiting-title">診間等候列表</h3>
          <div style="font-size:12px; color:var(--text-muted); margin-top:4px" id="clinic-waiting-subtitle">—</div>
        </div>
        <button class="modal-close" onclick="document.getElementById('clinic-waiting-modal').classList.remove('open')">✕</button>
      </div>
      <div id="clinic-waiting-body" class="modal-body">
        <div class="spinner"></div>
      </div>
    </div>
  </div>

  <!-- Doctor snapshot modal -->
  <div class="modal-overlay" id="doctor-modal" onclick="closeModalIfOverlay(event)">
    <div class="modal">
      <div class="modal-header">
        <h3 id="doctor-modal-title">醫師門診詳情</h3>
        <button class="modal-close"
          onclick="document.getElementById('doctor-modal').classList.remove('open')">✕</button>
      </div>
      <div id="doctor-modal-body" class="modal-body"></div>
    </div>
  </div>

  <!-- ══════════════════════════════════════
     ADMIN EDIT USER MODAL
══════════════════════════════════════ -->
  <div class="modal-overlay" id="admin-edit-modal" onclick="closeModalIfOverlay(event)">
    <div class="modal" style="max-width:420px">
      <div class="modal-header">
        <h3>✏️ 編輯使用者</h3>
        <button class="modal-close"
          onclick="document.getElementById('admin-edit-modal').classList.remove('open')">✕</button>
      </div>
      <form id="admin-edit-form" onsubmit="submitAdminEdit(event)">
        <input type="hidden" id="edit-user-id">
        <div class="form-group">
          <label>顯示名稱</label>
          <input type="text" id="edit-display-name" placeholder="留空則不修改">
        </div>
        <div class="form-group">
          <label>新密碼 <span style="color:var(--text-muted);font-weight:normal">(選填，至少8字)</span></label>
          <input type="password" id="edit-new-password" placeholder="留空則不修改">
        </div>
        <div style="display:flex; gap:10px; margin-top:16px">
          <button type="submit" class="btn btn-primary" id="admin-edit-submit-btn">儲存</button>
          <button type="button" class="btn btn-secondary"
            onclick="document.getElementById('admin-edit-modal').classList.remove('open')">取消</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast-container"></div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="/static/js/app.js"></script>
</body>

</html>